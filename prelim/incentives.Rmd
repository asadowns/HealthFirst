---
title: "Performance-Based HealthCare Provider Incentives"
author: "Asa Downs - SADA Systems"
date: "December 11, 2015"
output: 
  html_document:
    fig_width: 14
    fig_height: 10
    css: style.css
---

##Background

The goal of this research was to examine potential models for Health First's Provider Compensation. Exploratory Research was done on publicly available Medicare data as a proxy for more detailed Insurer, Provider, and patient data. The gaol was to explore the relationship between patient outcomes, provider efficiency, and insurer-provider compensation models.

Future research could use a more diverse range of richer data sources that relate specificially to the chronic conditions Health First wishes to insure but this introductory research should provide a framework for integrating that data.

##Exploratory Analysis

Medicare's data was clean and most easy to match up based on Provider ID / Provider Number. All NA data was removed to simplify analysis. Data from 2014-2015 was used to reduce analysis scope. See Appendix 1 for data cleaning code.

```{r getdata, message=FALSE, warning=FALSE, echo=FALSE}
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rpart)
library(rpart.plot)
library(knitr)
library(kfigr)
library(scales)

if (!file.exists('Hospital_Revised_Flatfiles.zip')) {
  download.file('https://data.medicare.gov/views/bg9k-emty/files/Ma46xU4I05xsIKuEqLLi-N-s7GoO2ZefzJ7SYyTIKjA?content_type=application%2Fzip%3B%20charset%3Dbinary&filename=Hospital_Revised_Flatfiles.zip','Hospital_Revised_Flatfiles.zip',method='curl')
  downloadDate <- date()  
}

if (!file.exists('raw')) {
  unzip('Hospital_Revised_Flatfiles.zip', exdir="./raw")
}

if (!exists('merged')) {
  readmissionsMortality <- tbl_df(read.csv('raw/Readmissions and Deaths - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  readmissionsMortality <- readmissionsMortality %>% select(one_of(c("Provider.ID","Measure.ID","Score"))) %>% 
    na.omit() %>% mutate(Provider.ID=as.integer(Provider.ID))
  
  readmissionHipKnee <- subset(readmissionsMortality, Measure.ID=='READM_30_HIP_KNEE')
  readmissionTotal <- subset(readmissionsMortality, Measure.ID=='READM_30_HOSP_WIDE')
  colnames(readmissionTotal) <- c("Provider.ID", "Measure.ID", "READM_SCORE")
  
  effectiveCare <- tbl_df(read.csv('raw/Timely and Effective Care - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))

  totalPerformanceScore <- tbl_df(read.csv('raw/hvbp_tps_08_06_2015.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  totalPerformanceScore <- totalPerformanceScore %>% 
    select(one_of(c("Provider.Number","Weighted.Patient.Experience.of.Care.Domain.Score", "Weighted.Clinical.Process.of.Care.Domain.Score","Weighted.Outcome.Domain.Score","Weighted.Efficiency.Domain.Score","Hospital.Name","Total.Performance.Score","State", "Zip.Code"))) %>% 
    na.omit() %>% 
    mutate(Provider.Number=as.integer(Provider.Number)) %>% 
    group_by(State) %>% 
    filter(State=='FL') %>%
    gather(domain.type,domain.score, Weighted.Patient.Experience.of.Care.Domain.Score, Weighted.Clinical.Process.of.Care.Domain.Score, Weighted.Outcome.Domain.Score, Weighted.Efficiency.Domain.Score) %>%
    transform(Hospital.Name = reorder(Hospital.Name, domain.score))

  valueOfCare <- tbl_df(read.csv('raw/Payment and Value of Care - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  valueOfCare <- valueOfCare %>% select(one_of(c("Provider.ID","Value.of.care.display.name","Value.of.care.category","Payment.category"))) %>% 
    na.omit() %>% mutate(Provider.ID=as.integer(Provider.ID))
  
  spendingPerPatient <- tbl_df(read.csv('raw/Medicare Hospital Spending per Patient - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  spendingPerPatient <- spendingPerPatient %>% select(one_of(c("Provider.ID","Hospital.Name","City","State","ZIP.Code","County.Name","Score"))) %>% 
    na.omit()
  
  valueCareSpending <- inner_join(spendingPerPatient, valueOfCare, by="Provider.ID")
  
  readmissionSpendingScore <- inner_join(spendingPerPatient, readmissionTotal, by="Provider.ID")
}
```

We first wanted to confirm there was a relationship between readmission rates and Medicare hospital spending per patient. We fitted a simple linear model to these two pieces of data.

```{r readmissionScoreBeneficiaryScore, echo=TRUE}
readmissionModel <- lm(Score~READM_SCORE,data=readmissionSpendingScore)
summary(readmissionModel)
```

This data is plotted below.

```{r readmissionScoreBeneficiaryScoreGraph, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(readmissionSpendingScore, aes(x=READM_SCORE, y=Score)) + 
  geom_point() + 
  geom_smooth(method="lm")
```

We next wanted to explore how Medicare links payment to quality: 

> The HVBP program is part of CMS’ long-standing effort to link Medicare’s payment system to quality. The program implements value-based purchasing to the payment system that accounts for the largest share of Medicare spending, affecting payment for inpatient stays in over 3,500 hospitals across the country. Hospitals are paid for inpatient acute care services based on the quality of care, not just quantity of the services they provide.

> The adjusts hospitals’ payments based on their performance on four domains that reflect hospital quality: the Clinical Process of Care Domain, the Patient Experience of Care domain, the Outcome domain, and the Efficiency domain. The Total Performance Score (TPS) is comprised of the Clinical Process of Care domain score (weighted as 20% of the TPS), the Patient Experience of Care domain score (weighted as 30% of the TPS), the Outcome domain score (weighted as 30% of the TPS), and the Efficiency domain score (weighted as 20% of the TPS).

Below are the top 25 Florida Hospitals scored using this 4-measure, weighted system. Full hospital data is stored in variable "totalPerformanceScore". Minimum score was, `r min(totalPerformanceScore$Total.Performance.Score)`, maximum score was, `r max(totalPerformanceScore$Total.Performance.Score)`.

```{r totalPerformance, echo=FALSE, warning=FALSE}
set.seed(40)
totalPerformanceScorePlot <- totalPerformanceScore %>% 
  arrange(Hospital.Name) %>%
  top_n(100, Hospital.Name) %>%
  filter(domain.type=='Weighted.Efficiency.Domain.Score')

ggplot(totalPerformanceScorePlot, aes(x=Hospital.Name, y=domain.score)) + 
  geom_bar(binwidth=1,aes(fill=domain.type),stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_discrete(name = "Domain", labels = c("Experience of Care", "Clinical Process of Care", "Outcome", "Efficiency")) + 
  xlab("Hospital Name") + ylab("Domain Score") + 
  ggtitle("Top 25 Florida Hospitals Total Performance Score (Weighted)")
```

We also looked into the part of the evaluation that is explicitly tied to efficiency as we felt this was an import piece of our evaluation. `r table(efficiencyScore$domain.score)[1]` of `r nrow(efficiencyScore)` have an efficiency score of zero the results for the rest are plotted below.

```{r efficiency score}
efficiencyScore <- totalPerformanceScore %>% 
  arrange(Hospital.Name) %>%
  filter(domain.type=='Weighted.Efficiency.Domain.Score') %>%
  transform(Hospital.Name = reorder(Hospital.Name, domain.score)) 

efficiencyScorePlot <- top_n(efficiencyScore, 57, Hospital.Name)

ggplot(efficiencyScorePlot, aes(x=Hospital.Name, y=domain.score)) +
  geom_bar(binwidth=1,stat="identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##Models

We came up and created several models for additional provider care

###Basic Compensation Model

Base compensation is linked to Overall Provider Quality (Clinical Process of Care Domain, the Patient Experience of Care domain, the Outcome domain, and the Efficiency domain). These figures could be compared to national,state, or local geographic averages. The average Florida provider score was `r round(mean(totalPerformanceScore$Total.Performance.Score),1)`. 

In order to prevent adverse selection consequences such as the best providers having the lowest rates and the highest quality of care copays/deductibles would be standardized across providers with the best providers getting to keep a larger piece of the copay and the worst providers keeping a lower percentage.

As an example, our base hospital has a 50:50 split on all network patient copays/deductibles with the network insurer. Assuming a $100 copay our mean insurer would be compensated $50.

The worst provider in our pool would receive:

```{r worstProvider}
baseCompensation <- 0.5
copay <- 100
worst <- (min(totalPerformanceScore$Total.Performance.Score) / mean(totalPerformanceScore$Total.Performance.Score))*baseCompensation*copay
dollar(worst)
```

Our best provider would receive: 

```{r bestProvider}
best <- (max(totalPerformanceScore$Total.Performance.Score) / mean(totalPerformanceScore$Total.Performance.Score))*baseCompensation*copay
dollar(best)
```

This system could also be easily modified to include minimum and maximum levels of compensation for providers. The base split could also be adjusted to fit real-world conditions.

More advanced versions of this model could use multiple years of historical score data to predict coming years scores.

####Variant: Tiers

A variant to the above compensation solution would be to rank hospitals by tiers (national, state, regional). This approach has the benefit that hospitals can be motivated to improve their rank by improving their score to predefined/periodically defined threshold. 

At a state level this could be as straightforward as determining the decile thresholds for the previous years performance and compensating each provider for the coming year based on where they fall by a fixed percentage say 5%.
```{r decileModel}
quantile(totalPerformanceScore$Total.Performance.Score,probs=seq(0,1,0.1))
```

Using this model our worst performing provider would keep $25 of the $100 copay, and the best performing provider would keep $75.

On a more granular level hospitals could be ranked and compensated according to how well they did relative to their peers in a geographic region.

###Efficiency-linked Compensation Incentives

Whereas our previous model suggested a method for establishing base compensation there would ideally be a variable piece of each provider's compensation that would be linked to efficiency since this is the one element in the overall compensation model that directly effects the insurer's balance sheet. Efficiency bonuses could be provided


##Appendices

###Appendix 1
```{r getdataAppendix, eval=FALSE}
library(dplyr)
library(tidyr)
library(caret)
library(randomForest)
library(rpart)
library(rpart.plot)
library(knitr)
library(kfigr)

if (!file.exists('Hospital_Revised_Flatfiles.zip')) {
  download.file('https://data.medicare.gov/views/bg9k-emty/files/Ma46xU4I05xsIKuEqLLi-N-s7GoO2ZefzJ7SYyTIKjA?content_type=application%2Fzip%3B%20charset%3Dbinary&filename=Hospital_Revised_Flatfiles.zip','Hospital_Revised_Flatfiles.zip',method='curl')
  downloadDate <- date()  
}

if (!file.exists('raw')) {
  unzip('Hospital_Revised_Flatfiles.zip', exdir="./raw")
}

if (!exists('merged')) {
  readmissionsMortality <- tbl_df(read.csv('raw/Readmissions and Deaths - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  readmissionsMortality <- readmissionsMortality %>% select(one_of(c("Provider.ID","Measure.ID","Score"))) %>% 
    na.omit() %>% mutate(Provider.ID=as.character(Provider.ID))
  
  readmissionHipKnee <- subset(readmissionsMortality, Measure.ID=='READM_30_HIP_KNEE')
  readmissionTotal <- subset(readmissionsMortality, Measure.ID=='READM_30_HOSP_WIDE')
  colnames(readmissionTotal) <- c("Provider.ID", "Measure.ID", "READM_SCORE")
  
  effectiveCare <- tbl_df(read.csv('raw/Timely and Effective Care - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))

  totalPerformanceScore <- tbl_df(read.csv('raw/hvbp_tps_08_06_2015.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  totalPerformanceScore <- totalPerformanceScore %>% 
    select(one_of(c("Provider.Number","Weighted.Patient.Experience.of.Care.Domain.Score", "Weighted.Clinical.Process.of.Care.Domain.Score","Weighted.Outcome.Domain.Score","Weighted.Efficiency.Domain.Score","Hospital.Name","Total.Performance.Score","State"))) %>% 
    na.omit() %>% 
    mutate(Provider.Number=as.character(Provider.Number)) %>% 
    group_by(State) %>% 
    filter(State=='FL') %>%
    gather(domain.type,domain.score, Weighted.Patient.Experience.of.Care.Domain.Score, Weighted.Clinical.Process.of.Care.Domain.Score, Weighted.Outcome.Domain.Score, Weighted.Efficiency.Domain.Score) %>%
    transform(Hospital.Name = reorder(Hospital.Name, domain.score))

  valueOfCare <- tbl_df(read.csv('raw/Payment and Value of Care - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  valueOfCare <- valueOfCare %>% select(one_of(c("Provider.ID","Value.of.care.display.name","Value.of.care.category","Payment.category"))) %>% 
    na.omit() %>% mutate(Provider.ID=as.character(Provider.ID))
  
  spendingPerPatient <- tbl_df(read.csv('raw/Medicare Hospital Spending per Patient - Hospital.csv', stringsAsFactors = FALSE, header = TRUE, na.strings=c("Not Available","Too Few To Report")))
  spendingPerPatient <- spendingPerPatient %>% select(one_of(c("Provider.ID","Hospital.Name","City","State","ZIP.Code","County.Name","Score"))) %>% 
    na.omit()
  
  valueCareSpending <- inner_join(spendingPerPatient, valueOfCare, by="Provider.ID")
  
  readmissionSpendingScore <- inner_join(spendingPerPatient, readmissionTotal, by="Provider.ID")
}
```
